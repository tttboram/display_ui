<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>DISPLAY</title>
  <link rel="stylesheet" href="../asset/css/main.css" />
  <script src="../asset/js/lib/jquery-2.2.4.min.js"></script>
</head>
<body>
<main>
  <!-- WEB -->  
  <div id="signage-stage">

    <!-- B: 10368*864 -->
    <div class="panel-b">
      <!-- background video -->
      <video class="bg_mov2" src="../asset/image/bg_part2.mp4" width="10368px" height="864px" autoplay muted></video>

      <div class="board board-now fade-stage">
        <div class="board-time">
          <div class="clock-row">
            <span class="clock-hhmm">
              <span class="ani-time hour1 delay-1">1</span><span class="ani-time hour2 delay-2">1</span>
              <span class="var fadein delay-4 ">:</span>
              <span class="ani-time minute1 delay-1">2</span><span class="ani-time minute2 delay-2">7</span></span>
            <span class="clock-ampm fadein delay-4">AM</span>
          </div>
        </div>

        <div class="board-today">
          <div class="weather-row">
            <div class="weather-icon ani-weather delay-3">
              <!-- <img src="../asset/image/icon/icon_snow.gif" alt="" class="size-m"> -->
              <!-- <img src="../asset/image/icon/icon_sun.gif" alt="" class="size-m"> -->
              <img src="../asset/image/icon/icon_sun_cloud.gif" alt="" class="size-m">
              <!-- <img src="../asset/image/icon/icon_cloud.gif" alt="" class="size-m"> -->
              <!-- <img src="../asset/image/icon/icon_flash.gif" alt="" class="size-m"> -->
              <!-- <img src="../asset/image/icon/icon_moon.gif" alt="" class="size-m"> -->
              <!-- <img src="../asset/image/icon/icon_moon_cloud.gif" alt="" class="size-m"> -->
              <!-- <img src="../asset/image/icon/icon_rain.gif" alt="" class="size-m"> -->
            </div>
            <div class="weather-text ani-weather delay-2"></div>
            <div class="weather-text-en ani-weather delay-1"></div>
          </div>
          <div class="day-row">
            <div class="day-today ani-weather delay-1">화요일, 9월 23일</div>
            <div class="day-today-en ani-weather delay-4">Tuesday, 9 Sep 23</div>
          </div>
          <div class="dust-row">
            <div class="dust-item ani-weather delay-2">
              <span class="dust-label">미세먼지</span>
              <span class="dust-value">21</span>
              <span class="dust-grade">좋음</span>
            </div>
            <div class="dust-item ani-weather delay-3">
              <span class="dust-label">초미세먼지</span>
              <span class="dust-value">6</span>
              <span class="dust-grade">좋음</span>
            </div>
          </div>
        </div>
      </div>

      <div class="board board-weather fade-stage">
        <div class="temp-row">
          <div class="temp-num">
            <span class="ani-time delay-1">2</span>
            <span class="ani-time delay-2">2</span>
            <span class="dosi ani-weather delay-3">°</span>
          </div>
          <div class="temp-condition ani-weather delay-1">
            <span class="condition-kr">맑음</span>
            <span class="condition-en">Sunny</span>
          </div>

          <div class="temp-dust">
            <span class="dust-item ani-weather delay-3"><b>미세먼지</b> <i>21</i> 좋음</span>
            <span class="dust-item ani-weather delay-2"><b>초미세먼지</b> <i>6</i> 좋음</span>
          </div>
        </div>

        <div class="timeline-cell">
          <div class="timeline-row">
            <div class="today">Today</div>
            <div class="date">
              <div class="date-kr">화요일, 9월 23일</div>
              <div class="date-en">Tuesday, 9 Sep 23</div>
            </div>
          </div>

          <div class="chart-row" >
            <!-- chart --> 
            <div id="chart-container"></div>
          </div>

          <!-- 시간대별 -->
          <div class="hourly-row">
            <div class="hour-item">
              <div class="ani-slide">
                <div class="w-icon">
                  <img src="../asset/image/icon/icon_snow.gif" alt="" class="size-s">
                </div>
              </div>
              <div class="h-temp">17°</div>
              <div class="h-time">오전 10시</div>
            </div>

            <div class="hour-item">
              <div class="ani-slide">
                <div class="w-icon">
                  <img src="../asset/image/icon/icon_sun.gif" alt="" class="size-s">
                </div>
              </div>
              <div class="h-temp">21°</div>
              <div class="h-time">오후 12시</div>
            </div>

            <div class="hour-item">
              <div class="ani-slide">
                <div class="w-icon">
                  <img src="../asset/image/icon/icon_flash.gif" alt="" class="size-s">
                </div>
              </div>
              <div class="h-temp">20°</div>
              <div class="h-time">오후 2시</div>
            </div>

            <div class="hour-item">
              <div class="ani-slide">
                <div class="w-icon">
                  <img src="../asset/image/icon/icon_moon.gif" alt="" class="size-s">
                </div>
              </div>
              <div class="h-temp">18°</div>
              <div class="h-time">오후 4시</div>
            </div>

            <div class="hour-item">
              <div class="ani-slide">
                <div class="w-icon">
                  <img src="../asset/image/icon/icon_moon_cloud.gif" alt="" class="size-s">
                </div>
              </div>
              <div class="h-temp">22°</div>
              <div class="h-time">오후 6시</div>
            </div>

            <div class="hour-item">
              <div class="ani-slide">
                <div class="w-icon">
                  <img src="../asset/image/icon/icon_cloud.gif" alt="" class="size-s">
                </div>
              </div>
              <div class="h-temp">23°</div>
              <div class="h-time">오후 8시</div>
            </div>
          </div>

        </div>
      </div>


      <div class="board board-clock">
        <div class="board-time">
          <div class="clock-row">
            <span class="clock-hhmm">
              <span class="ani-time hour1 delay-1">1</span><span class="ani-time hour2 delay-2">1</span>
              <span class="var fadein delay-4 ">:</span>
              <span class="ani-time minute1 delay-1">2</span><span class="ani-time minute2 delay-2">7</span>
            </span>
            <span class="clock-ampm fadein delay-4">AM</span>
          </div>
      </div>
    </div>

  </div>

</main>

<script>
  //////// 시간 및 날짜 ////////////
    function updateClock() {
   

      const now = new Date();

      // 1. 날짜 정보 (연-월-일)
      const year = now.getFullYear();
      const month = now.getMonth() + 1; // 월은 0부터 시작하므로 +1
      const date = now.getDate();

      const monthList_en = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const monthName_en = monthList_en[now.getMonth()];

      // 2. 요일 정보 (한글 변환)
      const dayList = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
      const dayList_en = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const dayName = dayList[now.getDay()];
      const dayName_en = dayList_en[now.getDay()];

      // 3. 시간 정보 (12시간제 및 AM/PM)
      let hours = now.getHours();

      const minutes = String(now.getMinutes()).padStart(2, '0'); // 두 자리 유지
      let minute1 = minutes.substr(0, 1);
      let minute2 = minutes.substr(1, 2);

      const seconds = String(now.getSeconds()).padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';

      // 12시간제로 변환
      hours = hours % 12;
      hours = hours ? hours : 12; // 0시일 경우 12로 표시

      const hours_tmp = String(hours).padStart(2, '0'); // 두 자리 유지
      let hours1 = hours_tmp.substr(0, 1);
      let hours2 = hours_tmp.substr(1, 2);

      const board_time = document.querySelector('.board-time');
      let any_times = board_time.querySelectorAll('.ani-time');
      
      any_times[0].innerHTML = hours1;
      any_times[1].innerHTML = hours2;

      any_times[2].innerHTML = minute1;
      any_times[3].innerHTML = minute2;
      
      board_time.querySelector('.clock-ampm').innerHTML = ampm;

      const board_clock = document.querySelector('.board-clock');
      let any_times2 = board_clock.querySelectorAll('.ani-time');
      
      any_times2[0].innerHTML = hours1;
      any_times2[1].innerHTML = hours2;

      any_times2[2].innerHTML = minute1;
      any_times2[3].innerHTML = minute2;

      board_clock.querySelector('.clock-ampm').innerHTML = ampm;

      const board_today = document.querySelector('.board-today');
      const board_today2 = document.querySelector('.timeline-row');

      let dateStr = dayName + ', ' + month + '월 ' + date + '일';
      board_today.querySelector('.day-today').innerHTML = dateStr;
      board_today2.querySelector('.date-kr').innerHTML = dateStr;

      let dateStr_en = dayName_en + ', ' + month + ' ' + monthName_en + ' ' + date;
      board_today.querySelector('.day-today-en').innerHTML = dateStr_en;
      board_today2.querySelector('.date-en').innerHTML = dateStr_en;

      // 결과 출력
      // console.log(`현재 날짜: ${year}년 ${month}월 ${date}일 (${dayName})`);
      // console.log(`현재 시간: ${ampm} ${hours}:${minutes}:${seconds}`);
     }

     // 페이지 로드 시 즉시 실행 후 1초마다 반복
      updateClock();
      setInterval(updateClock, 1000);
</script>

<script src="../asset/js/woori.js?ver=1.1"></script>
<script src="../asset/js/lib/echarts.common.min.js"></script>

<script>
 
  var dom = document.getElementById('chart-container');
  var myChart = echarts.init(dom, null, {
    renderer: 'svg',
    useDirtyRect: false
  });
  var app = {};


  var option;

  option = {
    backgroundColor: "transparent",
    grid: {
      left: 20,
      right: 20,
      top: 35,
      bottom: 35,
      containLabel: false
    },
    
    xAxis: {
      type: "category",
      boundaryGap: false,
      data: ["AM10", "AM12", "PM2", "PM4", "PM6", "PM8"],
      show: false,
      axisLabel: { show: false },
      axisTick: { show: false },
      axisLine: { show: false },
    },
    yAxis: {
      type: "value",
      show: false,
       min: function (value) {
          return value.min - 10;   // 아래 여백
        },
        max: function (value) {
          return value.max + 8;   // 위 여백
        }
    },
    series: [
      {
        symbolSize: 0,
        data: [
          0, 
          0,
          0, 
          0, 
          0, 
          0],
        type: "line",
        smooth: true, // 라벨 잘림 방지
        areaStyle: {
          origin: 'start',   // 무조건 아래로 채우기
          color: 'rgba(57, 192, 233, 0.3)',
        },
        clip: false,
        itemStyle: {
          color: '#FFFFFF'   // 포인트 색상
        },
        lineStyle: {
          color: "#ffffff",
          width: 6,
          shadowBlur: 18,
          shadowColor: 'rgba(255, 255, 255, 0.5)',
          shadowOffsetX: 8,
          shadowOffsetY: 8,
        },
      },
    ],
  };


  if (option && typeof option === 'object') {
    myChart.setOption(option);
  }

  window.addEventListener('resize', myChart.resize);


  /////////////
  //////// 날씨 API 연동 ////////////////////////////
  //////////
  function updateChartWithHighlight(rawData, curHourIdx) {
    const formattedData = rawData.map((val, index) => {
      const n = rawData.length;
      const isFirst = index === 0;
      const isLast = index === n - 1;
      const isCurrent = index === curHourIdx;
      
      const numVal = Number(val);

      if (!isCurrent) return numVal;

      if (index === curHourIdx) { 
        return {
          value: val,
          itemStyle: { color: '#FFFFFF' }, // 강조 포인트
          label: {
            show: true,
            distance: -15,
            textAlign: 'center',
            verticalAlign: 'middle',
            fontFamily: 'Roboto', 
            fontSize: 50,      // ★ 이 포인트만 크게
            letterSpacing: -2,
            color: '#000000',
            position: 'inside',
            //position: isFirst ? 'right' : isLast ? 'left' : 'top',
            // ★ offset도 첫/끝/중간에 맞춰 자동 변경 
            offset: isFirst ? [70, -10] : isLast ? [-70, -10] : [0, -10],
            
            formatter: '{c}°',

            // (선택) 라벨 배경도 함께 부드럽게
            backgroundColor: '#ffffff',
            width: 100,
            height: 100,
            lineHeight: 100,
            borderRadius: 50,

            shadowBlur: 25,
            shadowColor: 'rgba(255, 255, 255, 0.5)',
            shadowOffsetX: 0,
            shadowOffsetY: 0
          }
        };
      }
      // 일반 데이터는 숫자만 반환
      return val; 
    });

    myChart.setOption({
      series: [{
        data: formattedData
      }]
    });
  }

    // const res = getVilageBaseTime();
    // console.log(`단기예보 요청값: 날짜 ${res.baseDate}, 시각 ${res.baseTime}`);

    async function fetchWeatherData() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const todayStr = `${year}${month}${day}`;

        // 1. 현재 실황 조회 (초단기실황)
        // 실황은 매시각 40분 이후에 생성됩니다.
        let baseTime = now.getHours() + "00";
        if (now.getMinutes() < 45) {
            baseTime = (now.getHours() - 1) + "00";
        }
        
        const ncstUrl = `${API_URL}/1360000/VilageFcstInfoService_2.0/getUltraSrtFcst?serviceKey=${SERVICE_KEY}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${todayStr}&base_time=${baseTime.padStart(4, '0')}&nx=${NX}&ny=${NY}`;

        // 2. 단기 예보 조회 (08시~20시 정보를 위해 05시 발표 데이터 사용)
        const fcstUrl = `${API_URL}/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${SERVICE_KEY}&pageNo=1&numOfRows=200&dataType=JSON&base_date=${todayStr}&base_time=0500&nx=${NX}&ny=${NY}`;

        try {
            // 현재 실황 데이터 처리
            const ncstRes = await fetch(ncstUrl);
            const ncstData = await ncstRes.json();
            const ncstItems = ncstData.response.body.items.item;
            // const T1H = ncstItems.find(i => i.category === 'T1H').obsrValue; // 기온
            // const PTY = ncstItems.find(i => i.category === 'PTY').obsrValue; // 강수형태
            

            const items = ncstData.response.body.items.item;

            // 현재 시간과 가장 가까운 예보 시각을 현재 날씨로 사용 (HH00 포맷)
            const hours = now.getHours();

            let weatherInfo = {
                T1H: '', // 기온
                SKY: '', // 하늘상태
                PTY: ''  // 강수형태
            };
            
            const earliestTime = items[0].fcstTime; 
            items.forEach(item => {
                // 특정 시간이 아니라, API가 제공하는 가장 빠른 예보 시각의 데이터를 추출
                if (item.fcstTime === earliestTime) {
                    if (['T1H', 'SKY', 'PTY'].includes(item.category)) {
                        weatherInfo[item.category] = item.fcstValue;
                    }
                }
            });

            console.log(`--- [${todayStr} ${baseTime} 기준 날씨] ---`);
            console.log(`기온: ${weatherInfo.T1H}°C`);
            console.log(`하늘상태: ${skyMap[weatherInfo.SKY] || '정보없음'}`);

            console.log(`현재 기온: ${weatherInfo.T1H}, 현재 상태 : ${getWeatherStatusLabel(weatherInfo.SKY, weatherInfo.PTY, hours)}`);

            if (weatherInfo.PTY !== '0') {
                console.log(`강수형태: ${ptyMap[weatherInfo.PTY]}`);
            }
            
            // 영상 설정
            let mediaName = getWeatherMediaName(1, weatherInfo.SKY, weatherInfo.PTY, hours);
            console.log(`영상파일: ${mediaName}`);
            const videoElement = document.querySelector('video');
            videoElement.src = `../asset/${mediaName}`;
            videoElement.load(); // 새로운 소스를 적용하기 위해 호출
            videoElement.play(); // 자동 재생 (브라우저 정책에 따라 음소거(muted)가 필요할 수 있음)

            const board_today = document.querySelector('.board-today');

            let gif = getWeatherGif(weatherInfo.SKY, weatherInfo.PTY, hours);
            console.log(`gif : ${gif}`);

            board_today.querySelector('.weather-icon').innerHTML = `<img src="../asset/image/icon/${gif}" alt="" class="size-m">`;


            board_today.querySelector('.weather-text').innerHTML = getWeatherStatusLabel(weatherInfo.SKY, weatherInfo.PTY);
            board_today.querySelector('.weather-text-en').innerHTML = getWeatherStatusLabel_En(weatherInfo.SKY, weatherInfo.PTY);

            let ani_times = document.querySelector('.temp-row').querySelectorAll('.ani-time');
            const res_temp = splitTemperature(weatherInfo.T1H);

            ani_times[0].innerHTML = `${res_temp.sign}${res_temp.tens || ''}`;
            ani_times[1].innerHTML = res_temp.units;

            // 단기 예보 데이터 처리
            const fcstRes = await fetch(fcstUrl);
            const fcstData = await fcstRes.json();
            const fcstItems = fcstData.response.body.items.item;


            let weatherData = [];
            // 10:00부터 20:00까지 필터링
            for (let h = 10; h <= 20; h++) {
                if((h % 2) != 0)
                    continue;
                const timeStr = String(h).padStart(2, '0') + "00";

                // 초단기 예보에서 우선 찾고 없을 경우 단기예보 데이터에서 찾음.
                let sky = ncstItems.find(i => i.fcstTime === timeStr && i.category === 'SKY')?.fcstValue;
                if(sky === undefined)
                  sky = fcstItems.find(i => i.fcstTime === timeStr && i.category === 'SKY')?.fcstValue;
                
                let pty = ncstItems.find(i => i.fcstTime === timeStr && i.category === 'PTY')?.fcstValue;
                if(pty === undefined)
                  pty = fcstItems.find(i => i.fcstTime === timeStr && i.category === 'PTY')?.fcstValue;

                let tmp = ncstItems.find(i => i.fcstTime === timeStr && i.category === 'T1H')?.fcstValue;
                if(tmp === undefined)
                  tmp = fcstItems.find(i => i.fcstTime === timeStr && i.category === 'TMP')?.fcstValue;

                weatherData.push({
                  hour : `${h}`,
                  sky : `${getWeatherGif(sky, pty, h)}`,
                  tmp : `${tmp}`
                });
            }
            
            console.log(weatherData);
            var tmpOnly = weatherData.map(function(item) {
              return item.tmp;
            });

            console.log(tmpOnly); 

            const recentTime = getRecentTime();
            console.log(`현재 시간 기준 가장 가까운 타임슬롯: ${recentTime}시`);
            const index = timeSlots.indexOf(recentTime);

            //const timeSlots1 = [29, 32, 33, 36, 34, 30];
            updateChartWithHighlight(tmpOnly, index);

            const elements = document.querySelectorAll('.hour-item');
            elements.forEach((el, index) => {
                el.querySelector('.h-temp').innerHTML = tmpOnly[index] + '°';
                el.querySelector('.w-icon').innerHTML = `<img src="../asset/image/icon/${weatherData[index].sky}" alt="" class="size-s">`;
            });

        } catch (error) {
            console.error("데이터 로드 실패:", error);
        }
    }

    fetchWeatherData();
  

    ////// 대기정보 /////////////////
    async function fetchDnstyData() {
        ////////////// 대기정보 /////////////////
      const pmGradeNameList = ['매우좋음', '좋음', '보통', '나쁨', '매우나쁨'];
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const dateKye = year + '.' + month + '.' + day + '.' + hours;

      const dnstyUrl = `${API_URL}/B552584/ArpltnInforInqireSvc/getMsrstnAcctoRltmMesureDnsty?serviceKey=d62feb6b3e43fb95f2af9e228f7f4e93a33f37778489afa4c8d0c40e15524af6&returnType=json&numOfRows=100&pageNo=1&stationName=%EC%A2%85%EB%A1%9C%EA%B5%AC&dataTerm=DAILY&ver=1.0&dateKey=${dateKye}`;

      try {
          // 현재 실황 데이터 처리
          const dnstyRes = await fetch(dnstyUrl);
          const dnstyData = await dnstyRes.json();
          
          if(dnstyData.response.body.totalCount > 0){
            var item = dnstyData.response.body.items[dnstyData.response.body.totalCount - 1];
            console.log(item);

            const board_today = document.querySelector('.board-today');
            let dust_items = board_today.querySelector('.dust-row').querySelectorAll('.dust-item')

            const temp_row = document.querySelector('.temp-dust');
            let dust_items2 = temp_row.querySelectorAll('.dust-item');

            var pm10Grade = item.pm10Grade;
            var pm10Value = item.pm10Value;
            dust_items[0].querySelector('.dust-value').innerHTML = pm10Value;
            dust_items[0].querySelector('.dust-grade').innerHTML = pmGradeNameList[pm10Grade];
            dust_items2[0].innerHTML = `<b>미세먼지</b> <i>${pm10Value}</i> ${pmGradeNameList[pm10Grade]}`

            var pm25Grade = item.pm25Grade;
            var pm25Value = item.pm25Value;
            dust_items[1].querySelector('.dust-value').innerHTML = pm25Value;
            dust_items[1].querySelector('.dust-grade').innerHTML = pmGradeNameList[pm25Grade];
            dust_items2[1].innerHTML = `<b>미세먼지</b> <i>${pm25Value}</i> ${pmGradeNameList[pm25Grade]}`
            
          }
              
      } catch (error) {
          console.error("데이터 로드 실패:", error);
      }
    }

    fetchDnstyData();

</script>
</body>

</html>
